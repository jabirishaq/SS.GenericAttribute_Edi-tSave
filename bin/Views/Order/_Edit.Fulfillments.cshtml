@model OrderModel
@{
    bool IsFulfillmentPluginInstalled = ViewBag.IsFulfillmentPluginInstalled == null ? false : Convert.ToBoolean(ViewBag.IsFulfillmentPluginInstalled);
}
<style>
    .btn-fulfillment {
        position: relative !important;
        visibility: visible !important;
    }
</style>
<div>
    @(Html.Telerik().Grid<OrderModel.OrderFulfillmentModel>().Name("orderfulfillment-grid")
            .DataKeys(keys =>
            {
                keys.Add(x => x.Id).RouteKey("Id");
                //keys.Add(x => x.OrderId).RouteKey("orderId");
            })
            .DataBinding(binding =>
            {
                binding.Ajax().Select("OrderFulfillmentSelect", "Order", new { orderId = Model.Id });
                // .Delete("OrderFulfillmentDelete", "Order");
            })
            .Columns(columns =>
            {

                columns.Bound(x => x.FulfillmentOrderID).Width(180);
                columns.Bound(x => x.OrderStatusName).Width(180);
                columns.Bound(x => x.UpdateDateTime).Width(180);
                //columns.Bound(x => x.FulfillmentOrderID)
                //    .Sortable(false)
                //    .Centered()
                //    .Width(120)
                //    .ClientTemplate(Html.Widget("resend_veracore_button_<%= c.Id %>").ToString());

                if (IsFulfillmentPluginInstalled)
                {
                    columns.Bound(x => x.Id)
                    .Title("")
                    .ClientTemplate("<input type='button' data-veracore-orderid='<#=Id #>' id='resend-to-veracore-<#=Id #>' class='btn btn-danger btn-fulfillment' value='Fulfillment' />");
                }


                //.Template(x => Html.RenderWidget("resend_veracore_button_" + x.Id));
                //.ClientTemplate(@Html.Widget("resend_veracore_button_<%= c.Id %>"));
            })
            .EnableCustomBinding(true)
            .DetailView(details => details.ClientTemplate(
                Html.Telerik().Grid<OrderModel.OrderItemFulfillmentModel>()
                    .Name("orderitemfulfillment-grid<#= Id #>")
                    .DataKeys(keys => { keys.Add(x => x.Id); })
                    .Columns(c =>
                    {
                        c.Bound(x => x.Sku).Width(150);
                        c.Bound(x => x.QuantityMultipler).Width(150);
                        //c.Command(commands =>
                        //{
                        //    commands.Edit().Localize(T);
                        //    commands.Delete().Localize(T);
                        //})
                        //.HtmlAttributes(new { align = "right" });
                    })
                    .DataBinding(dataBinding =>
                    {
                        dataBinding.Ajax()
                        .Select("OrderItemFulfillmentSelect", "Order", new { orderFulfillmentId = "<#= Id #>" });
                        //.Update("OrderItemFulfillmentUpdate", "Order")
                        //.Delete("OrderItemFulfillmentDelete", "Order", new { orderFulfillmentId = "<#= Id #>", orderItemFulfillmentId = "<#= item.Id #>" });
                    })
                    .EnableCustomBinding(true)
                       .ToHtmlString()
                ))
            )
</div>


@if (!IsFulfillmentPluginInstalled)
{

    return;

}


<script type="text/javascript">


        var veracoreOrderId;
        $(document).ready(function () {
            /*alert('test');*/
            debugger;

            $(document).on('click', '.btn-fulfillment', function (e) {

               e.preventDefault();

                var ele = $(this);

                veracoreOrderId = ele.data('veracore-orderid');

                ajaxResendToPromail(veracoreOrderId, false);

            });

            $(document).on('click', '#confirm-resend-to-veracore', function (e) {

                e.preventDefault();

                var ele = $(this);

                //var veracoreOrderId = ele.data('veracore-orderid');

                ajaxResendToPromail(veracoreOrderId, true);

            });


        });

    function ajaxResendToPromail(veracoreOrderId, isConfirmResend) {

        var model = { id: veracoreOrderId, isConfirmResend: isConfirmResend };

                $.ajax({
                    url : "@Url.Action("ResendToPromail2", "VeraCore", new { area = "SmartStore.Fulfillment" })",
                    type : 'POST',
                    dataType: 'json',
                    contentType: 'application/json',
                    data: JSON.stringify(model),
                    success: function (result) {

                        if (result.isExistPromailOrder) {

                            $("#veracore-message").html("The Order '" + result.data.payload.VeraCoreOrderId + "' already exists in VeraCore. Are you sure you want to submit it again?");
                            $('#ResendToVeraCoreModal').modal('show');

                        }

                        if (result.data.payload.VeraCoreOrderSeqId > 0) {
                            EventBroker.publish("message", { title: "Sent to VeraCore", type: "success", delay: 1000 });

                            var grid = $('#orderfulfillment-grid').data('tGrid');
                            grid.currentPage = 1;
                            grid.ajaxRequest();

                        }
                        else if (isConfirmResend){

                            EventBroker.publish("message", { title: result.data.payload.Error == null ? 'Resend failed.' : result.data.payload.Error, type: "error", delay: 1000 });

                        }


                    },
                    error: function(e){
                        EventBroker.publish("message", { title: e, type: "error", delay: 1000 });

                    }
                });
        }

</script>



@*<div id="resend-veracore-dialog-modal" class="modal fade" tabindex="-1" style="z-index:999999">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="myModalLabel">Fulfillment</h4>
                <button type="button" class="close" data-dismiss="modal">
                    <span aria-hidden="true">&times;</span><span class="sr-only">Close</span>
                </button>
            </div>
            <div class="modal-body p-3" id="veracore-message">

            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" data-button-action="cancel" id="resend-veracore-cancel-button">Cancel</button>
                <button class="btn btn-danger" data-dismiss="modal" data-button-action="save" id="resend-veracore-confirm-button">Confirm</button>
            </div>
        </div>
    </div>
</div>*@

@{Html.SmartStore().Window()
            .Name("ResendToVeraCoreModal")
            .Title("Fulfillment")
            .Content(
@<text>
    <div class="modal-body p-2" id="veracore-message" style="font-weight:bold;font-size:larger">
        This order already exists in VeraCore. Are you sure you want to submit it again?
    </div>
</text>)
.FooterContent(
@<text>
    <button class="btn btn-secondary btn-flat" data-dismiss="modal">
        <span>@T("Common.Cancel")</span>
    </button>
    <button id="confirm-resend-to-veracore" class="btn btn-primary" data-dismiss="modal" >
        <span>@T("Common.OK")</span>
    </button>
</text>)
.Render(); }